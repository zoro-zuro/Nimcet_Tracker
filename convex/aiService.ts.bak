import { v } from "convex/values";

// AI Service Interface
export interface AIService {
  generateCustomPaper(constraints: {
    year?: number;
    section?: string;
    questionCount: number;
    difficultyDistribution?: {
      easy: number;
      medium: number;
      hard: number;
    };
  }): Promise<any>;
  
  askAI(args: {
    questionId?: string;
    questionText?: string;
    promptType: "hint" | "explain" | "similar";
  }): Promise<string>;
  
  suggestDailyPlan(userId: string): Promise<any>;
}

// Cerebras AI Adapter
export class CerebrasAdapter implements AIService {
  private apiKey: string;

  constructor(apiKey: string) {
    this.apiKey = apiKey;
  }

  async generateCustomPaper(constraints: any): Promise<any> {
    const prompt = `Generate a custom NIMCET paper with the following constraints:
      - Year: ${constraints.year || "Any"}
      - Section: ${constraints.section || "All"}
      - Question Count: ${constraints.questionCount}
      - Difficulty Distribution: ${JSON.stringify(constraints.difficultyDistribution)}
      
      Please provide a structured response with question blueprints including:
      - Question text
      - Options (A, B, C, D)
      - Correct answer
      - Topic/subtopic
      - Difficulty level
      - Explanation`;

    try {
      const response = await fetch("https://api.cerebras.ai/v1/chat/completions", {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${this.apiKey}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          model: "llama3.1-8b",
          messages: [{ role: "user", content: prompt }],
          max_tokens: 2000,
        }),
      });

      if (!response.ok) {
        throw new Error(`Cerebras API error: ${response.status}`);
      }

      const data = await response.json();
      return {
        success: true,
        content: data.choices[0].message.content,
        questions: this.parseQuestions(data.choices[0].message.content),
      };
    } catch (error) {
      console.error("Cerebras API error:", error);
      return {
        success: false,
        error: "Failed to generate custom paper",
        content: "",
      };
    }
  }

  async askAI(args: any): Promise<string> {
    let prompt = "";
    
    switch (args.promptType) {
      case "hint":
        prompt = `Provide a helpful hint for this NIMCET question: "${args.questionText}"`;
        break;
      case "explain":
        prompt = `Provide a detailed explanation for this NIMCET question: "${args.questionText}"`;
        break;
      case "similar":
        prompt = `Generate a similar NIMCET question to: "${args.questionText}"`;
        break;
    }

    try {
      const response = await fetch("https://api.cerebras.ai/v1/chat/completions", {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${this.apiKey}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          model: "llama3.1-8b",
          messages: [{ role: "user", content: prompt }],
          max_tokens: 500,
        }),
      });

      if (!response.ok) {
        throw new Error(`Cerebras API error: ${response.status}`);
      }

      const data = await response.json();
      return data.choices[0].message.content;
    } catch (error) {
      console.error("Cerebras API error:", error);
      return "Sorry, I couldn't get a response from the AI service.";
    }
  }

  async suggestDailyPlan(userId: string): Promise<any> {
    const prompt = `Generate a personalized daily NIMCET study plan based on:
      - User's weak areas (needs to be fetched from database)
      - Current progress and goals
      - Suggested practice questions and topics
      - Recommended study time distribution
      
      Please provide a structured daily plan with specific recommendations.`;

    try {
      const response = await fetch("https://api.cerebras.ai/v1/chat/completions", {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${this.apiKey}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          model: "llama3.1-8b",
          messages: [{ role: "user", content: prompt }],
          max_tokens: 1000,
        }),
      });

      if (!response.ok) {
        throw new Error(`Cerebras API error: ${response.status}`);
      }

      const data = await response.json();
      return {
        success: true,
        plan: data.choices[0].message.content,
      };
    } catch (error) {
      console.error("Cerebras API error:", error);
      return {
        success: false,
        error: "Failed to generate daily plan",
        plan: "",
      };
    }
  }

  private parseQuestions(content: string): any[] {
    // Simple parser to extract questions from AI response
    // This would be more sophisticated in a real implementation
    return [];
  }
}

// OpenAI Adapter (for future use)
export class OpenAIAdapter implements AIService {
  private apiKey: string;

  constructor(apiKey: string) {
    this.apiKey = apiKey;
  }

  async generateCustomPaper(constraints: any): Promise<any> {
    const prompt = `Generate a custom NIMCET paper with the following constraints:
      - Year: ${constraints.year || "Any"}
      - Section: ${constraints.section || "All"}
      - Question Count: ${constraints.questionCount}
      - Difficulty Distribution: ${JSON.stringify(constraints.difficultyDistribution)}
      
      Please provide a structured response with question blueprints including:
      - Question text
      - Options (A, B, C, D)
      - Correct answer
      - Topic/subtopic
      - Difficulty level
      - Explanation`;

    try {
      const response = await fetch("https://api.openai.com/v1/chat/completions", {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${this.apiKey}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          model: "gpt-3.5-turbo",
          messages: [{ role: "user", content: prompt }],
          max_tokens: 2000,
        }),
      });

      if (!response.ok) {
        throw new Error(`OpenAI API error: ${response.status}`);
      }

      const data = await response.json();
      return {
        success: true,
        content: data.choices[0].message.content,
        questions: this.parseQuestions(data.choices[0].message.content),
      };
    } catch (error) {
      console.error("OpenAI API error:", error);
      return {
        success: false,
        error: "Failed to generate custom paper",
        content: "",
      };
    }
  }

  async askAI(args: any): Promise<string> {
    let prompt = "";
    
    switch (args.promptType) {
      case "hint":
        prompt = `Provide a helpful hint for this NIMCET question: "${args.questionText}"`;
        break;
      case "explain":
        prompt = `Provide a detailed explanation for this NIMCET question: "${args.questionText}"`;
        break;
      case "similar":
        prompt = `Generate a similar NIMCET question to: "${args.questionText}"`;
        break;
    }

    try {
      const response = await fetch("https://api.openai.com/v1/chat/completions", {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${this.apiKey}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          model: "gpt-3.5-turbo",
          messages: [{ role: "user", content: prompt }],
          max_tokens: 500,
        }),
      });

      if (!response.ok) {
        throw new Error(`OpenAI API error: ${response.status}`);
      }

      const data = await response.json();
      return data.choices[0].message.content;
    } catch (error) {
      console.error("OpenAI API error:", error);
      return "Sorry, I couldn't get a response from the AI service.";
    }
  }

  async suggestDailyPlan(userId: string): Promise<any> {
    const prompt = `Generate a personalized daily NIMCET study plan based on:
      - User's weak areas (needs to be fetched from database)
      - Current progress and goals
      - Suggested practice questions and topics
      - Recommended study time distribution
      
      Please provide a structured daily plan with specific recommendations.`;

    try {
      const response = await fetch("https://api.openai.com/v1/chat/completions", {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${this.apiKey}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          model: "gpt-3.5-turbo",
          messages: [{ role: "user", content: prompt }],
          max_tokens: 1000,
        }),
      });

      if (!response.ok) {
        throw new Error(`OpenAI API error: ${response.status}`);
      }

      const data = await response.json();
      return {
        success: true,
        plan: data.choices[0].message.content,
      };
    } catch (error) {
      console.error("OpenAI API error:", error);
      return {
        success: false,
        error: "Failed to generate daily plan",
        plan: "",
      };
    }
  }

  private parseQuestions(content: string): any[] {
    // Simple parser to extract questions from AI response
    return [];
  }
}

// Factory function to create AI service
export function createAIService(): AIService | null {
  const cerebrasKey = process.env.CEREBRAS_API_KEY;
  const openaiKey = process.env.OPENAI_API_KEY;

  if (cerebrasKey) {
    return new CerebrasAdapter(cerebrasKey);
  } else if (openaiKey) {
    return new OpenAIAdapter(openaiKey);
  } else {
    return null;
  }
}

// Mock AI service for when no API key is configured
export class MockAIService implements AIService {
  async generateCustomPaper(constraints: any): Promise<any> {
    return {
      success: false,
      error: "AI service not configured. Please add your API key to use AI features.",
      content: "",
      questions: [],
    };
  }

  async askAI(args: any): Promise<string> {
    return "AI service not configured. Please add your API key to use AI features.";
  }

  async suggestDailyPlan(userId: string): Promise<any> {
    return {
      success: false,
      error: "AI service not configured. Please add your API key to use AI features.",
      plan: "",
    };
  }
}
